{% extends "base.html" %}

{% block title %}One Piece TCG Scanner{% endblock %}

{% block content %}

<!-- ========== CAMERA + INPUT SECTION ========== -->
<section class="scanner-section">
  <div class="camera-container">
    <!--
      Placeholder for now. In Milestone 5 you'll replace this
      with an <img> tag pointing to your MJPEG stream route.
    -->
    <div class="camera-placeholder">
      <p>üì∑ Camera Feed</p>
      <p class="hint">Coming in Milestone 5</p>
    </div>
  </div>

  <div class="scanner-controls">
    <button id="btn-capture" class="btn btn-capture" disabled>
      üì∏ Capture &amp; Auto-Detect
    </button>

    <form
      class="lookup-form"
      method="POST"
      action="{{ url_for('main.lookup') }}"
    >
      <input
        type="text"
        name="card_id"
        id="card-id-input"
        placeholder="e.g. OP01-001"
        pattern="[A-Za-z]{1,4}\d{2,3}-\d{3}"
        title="Format: OP01-001, ST01-012, EB01-001, etc."
        required
      />
      <button type="submit" class="btn btn-lookup">üîç Look Up</button>
    </form>
  </div>
</section>

<!-- ========== CARD DISPLAY SECTION ========== -->
<section class="card-section">
  {% if card %}
  <div class="card-nav">
    <!--
      prev_id / next_id will be None at the edges.
      Jinja2's `if` controls whether the link is clickable.
    -->
    {% if prev_id %}
    <a
      href="{{ url_for('main.index', card_index=prev_id) }}"
      class="btn btn-nav"
    >
      ‚óÄ Back
    </a>
    {% else %}
    <span class="btn btn-nav btn-disabled">‚óÄ Back</span>
    {% endif %}

    <div class="card-image-wrapper">
      {% if card.image_path %}
      <img
        src="{{ url_for('static', filename=card.image_path) }}"
        alt="{{ card.name }}"
        class="card-image"
      />
      {% else %}
      <!--
        Fallback: show image from API if we don't have
        a local photo yet (pre-Milestone 5).
      -->
      <img
        src="{{ card.card_image }}"
        alt="{{ card.name }}"
        class="card-image"
      />
      {% endif %}
    </div>

    {% if next_id %}
    <a
      href="{{ url_for('main.index', card_index=next_id) }}"
      class="btn btn-nav"
    >
      Forward ‚ñ∂
    </a>
    {% else %}
    <span class="btn btn-nav btn-disabled">Forward ‚ñ∂</span>
    {% endif %}
  </div>

  <div class="card-details">
    <h2>{{ card.card_name }}</h2>
    <table class="details-table">
      <tr>
        <th>Set ID</th>
        <td>{{ card.set_id }}</td>
      </tr>
      <tr>
        <th>Set</th>
        <td>{{ card.set_name or "‚Äî" }}</td>
      </tr>
      <tr>
        <th>Rarity</th>
        <td>
          <span class="rarity-badge rarity-{{ card.rarity | lower }}">
            Rarity: {{ card.rarity }}
          </span>
        </td>
      </tr>
      <tr>
        <th>Market Price</th>
        <td class="price">
          {% if card.market_price is not none %}
            ${{ "%.2f" | format(card.market_price) }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      </tr>
    </table>
  </div>

  {% else %}

  <!-- Empty state ‚Äî shown when no card is loaded yet -->
  <div class="empty-state">
    <p class="empty-icon">üÉè</p>
    <p>No card loaded yet.</p>
    <p class="hint">
      Type a card ID above and hit <strong>Look Up</strong> to get started.
    </p>
  </div>

  {% endif %}
</section>

<!-- ========== MULTI-RESULT MODAL ========== -->
<div id="card-select-modal" class="modal-overlay {% if not choices %}hidden{% endif %}">
  <div class="modal">
    <div class="modal-header">
      <h2>Multiple Results Found</h2>
      <button id="modal-close" class="btn-close" aria-label="Close">‚úï</button>
    </div>
    <p class="modal-subtitle">
      We found multiple versions. Pick the one you want:
    </p>

    <div class="modal-card-grid">
      {% if choices %}
        {% for choice in choices %}
        <form method="POST" action="{{ url_for('main.lookup') }}">
          <!--
            Hidden input sends the EXACT card ID back to your
            lookup route so there's no ambiguity the second time.
          -->
          <input type="hidden" name="card_id" value="{{ choice.card_set_id }}" />
          <input type="hidden" name="pick_index" value="{{ loop.index0 }}" />
          <button type="submit" class="modal-card">
            <img
              src="{{ choice.card_image }}"
              alt="{{ choice.card_name }}"
              class="modal-card-img"
            />
            <div class="modal-card-info">
              <span class="modal-card-id">{{ choice.set_id }}</span>
              <span class="modal-card-name">{{ choice.card_name }}</span>
              <span class="modal-card-rarity rarity-badge rarity-{{ choice.rarity | lower }}">
                Rarity: {{ choice.rarity }}
              </span>
              {% if choice.market_price is not none %}
              <span class="modal-card-price">
                ${{ "%.2f" | format(choice.market_price) }}
              </span>
              {% endif %}
            </div>
          </button>
        </form>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<!-- ========== SAVE CARD ========== -->
{% if card %}
<section class="save-section">
 {% if not saved %}
  <div class="save-controls">
    <form
      class="save-form"
      method="POST"
      action="{{ url_for('main.save') }}"
    >
      <input type="hidden" name="card_image" value="{{ card.card_image }}">
      <input type="hidden" name="card_name" value="{{ card.card_name }}">
      <input type="hidden" name="card_set_id" value="{{ card.set_id }}">
      <input type="hidden" name="card_set" value="{{ card.set_name }}">
      <input type="hidden" name="card_rarity" value="{{ card.rarity }}">
      <input type="hidden" name="card_market_price" value="{{ card.market_price }}">
      <input type="hidden" name="card_image_id" value="{{ card.card_image_id }}">
      <button type="submit" class="btn btn-save">üíæ Save</button>
    </form>
  </div>

  {% else %}
  <div class="save-controls">
      <button type="submit" class="btn btn-save">üíæ Saved!</button>
  </div>

  {% endif %}
</section>
{% endif %}


{% endblock %}